<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ImagePagerAdapter.kt</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">app</a> &gt; <a href="index.source.html" class="el_package">com.smilepile.app</a> &gt; <span class="el_source">ImagePagerAdapter.kt</span></div><h1>ImagePagerAdapter.kt</h1><pre class="source lang-java linenums">package com.smilepile.app

import android.content.Context
import android.graphics.Bitmap
import android.graphics.BitmapFactory
import android.view.LayoutInflater
import android.view.View
import android.view.ViewGroup
import android.widget.ImageView
import androidx.recyclerview.widget.RecyclerView
import kotlinx.coroutines.CoroutineScope
import kotlinx.coroutines.Dispatchers
import kotlinx.coroutines.launch
import kotlinx.coroutines.withContext
import java.io.IOException
import kotlin.math.ceil
import kotlin.math.floor
import kotlin.math.max

<span class="fc" id="L20">class ImagePagerAdapter(</span>
<span class="fc" id="L21">    private val context: Context,</span>
<span class="fc" id="L22">    private val imagePaths: List&lt;String&gt;</span>
<span class="fc" id="L23">) : RecyclerView.Adapter&lt;ImagePagerAdapter.ImageViewHolder&gt;() {</span>

<span class="nc" id="L25">    inner class ImageViewHolder(itemView: View) : RecyclerView.ViewHolder(itemView) {</span>
<span class="nc" id="L26">        val imageView: ImageView = itemView.findViewById(R.id.imageView)</span>
<span class="nc" id="L27">        var loadedBitmap: Bitmap? = null</span>
    }

    override fun onCreateViewHolder(parent: ViewGroup, viewType: Int): ImageViewHolder {
<span class="nc" id="L31">        val view = LayoutInflater.from(parent.context).inflate(R.layout.item_image, parent, false)</span>
<span class="nc" id="L32">        return ImageViewHolder(view)</span>
    }

    override fun onBindViewHolder(holder: ImageViewHolder, position: Int) {
        // Recycle previous bitmap to prevent memory leaks
<span class="nc bnc" id="L37" title="All 2 branches missed.">        holder.loadedBitmap?.let { bitmap -&gt;</span>
<span class="nc bnc" id="L38" title="All 2 branches missed.">            if (!bitmap.isRecycled) {</span>
<span class="nc" id="L39">                bitmap.recycle()</span>
            }
<span class="nc" id="L41">        }</span>
<span class="nc" id="L42">        holder.loadedBitmap = null</span>

<span class="nc bnc" id="L44" title="All 2 branches missed.">        if (imagePaths.isEmpty()) {</span>
            // Show placeholder when no images are available
<span class="nc" id="L46">            holder.imageView.setImageResource(android.R.drawable.ic_menu_gallery)</span>
<span class="nc" id="L47">            return</span>
        }

        // Show placeholder while loading
<span class="nc" id="L51">        holder.imageView.setImageResource(android.R.drawable.ic_menu_gallery)</span>

        // Load image asynchronously to prevent ANR
<span class="nc" id="L54">        CoroutineScope(Dispatchers.Main).launch {</span>
<span class="nc" id="L55">            try {</span>
<span class="nc bnc" id="L56" title="All 2 branches missed.">                val bitmap = withContext(Dispatchers.IO) {</span>
<span class="nc" id="L57">                    loadBitmapSafely(imagePaths[position], holder.imageView.width, holder.imageView.height)</span>
                }

                // Check if the holder is still valid (not recycled)
<span class="nc bnc" id="L61" title="All 4 branches missed.">                if (holder.adapterPosition == position &amp;&amp; bitmap != null) {</span>
<span class="nc" id="L62">                    holder.loadedBitmap = bitmap</span>
<span class="nc" id="L63">                    holder.imageView.setImageBitmap(bitmap)</span>
                }
<span class="nc" id="L65">            } catch (e: Exception) {</span>
                // Handle error by keeping the placeholder
                // Error already shown as placeholder
            }
<span class="nc" id="L69">        }</span>
<span class="nc" id="L70">    }</span>

<span class="fc bfc" id="L72" title="All 2 branches covered.">    override fun getItemCount(): Int = if (imagePaths.isEmpty()) 1 else imagePaths.size</span>

    override fun onViewRecycled(holder: ImageViewHolder) {
<span class="nc" id="L75">        super.onViewRecycled(holder)</span>
        // Recycle bitmap when view is recycled to prevent memory leaks
<span class="nc bnc" id="L77" title="All 2 branches missed.">        holder.loadedBitmap?.let { bitmap -&gt;</span>
<span class="nc bnc" id="L78" title="All 2 branches missed.">            if (!bitmap.isRecycled) {</span>
<span class="nc" id="L79">                bitmap.recycle()</span>
            }
<span class="nc" id="L81">        }</span>
<span class="nc" id="L82">        holder.loadedBitmap = null</span>
<span class="nc" id="L83">        holder.imageView.setImageDrawable(null)</span>
<span class="nc" id="L84">    }</span>

    /**
     * Safely loads a bitmap with proper memory management using inSampleSize
     * to prevent OutOfMemoryError
     */
    private fun loadBitmapSafely(imagePath: String, targetWidth: Int, targetHeight: Int): Bitmap? {
<span class="nc" id="L91">        return try {</span>
<span class="nc" id="L92">            val inputStream = context.assets.open(imagePath)</span>

            // First pass: get image dimensions without loading the full bitmap
<span class="nc" id="L95">            val options = BitmapFactory.Options().apply {</span>
<span class="nc" id="L96">                inJustDecodeBounds = true</span>
<span class="nc" id="L97">            }</span>
<span class="nc" id="L98">            BitmapFactory.decodeStream(inputStream, null, options)</span>
<span class="nc" id="L99">            inputStream.close()</span>

            // Calculate inSampleSize to reduce memory usage
<span class="nc" id="L102">            val sampleSize = calculateInSampleSize(options, targetWidth, targetHeight)</span>

            // Second pass: load the bitmap with calculated sample size
<span class="nc" id="L105">            val actualInputStream = context.assets.open(imagePath)</span>
<span class="nc" id="L106">            val finalOptions = BitmapFactory.Options().apply {</span>
<span class="nc" id="L107">                inJustDecodeBounds = false</span>
<span class="nc" id="L108">                inSampleSize = sampleSize</span>
<span class="nc" id="L109">                inPreferredConfig = Bitmap.Config.RGB_565 // Use less memory than ARGB_8888</span>
<span class="nc" id="L110">            }</span>

<span class="nc" id="L112">            val bitmap = BitmapFactory.decodeStream(actualInputStream, null, finalOptions)</span>
<span class="nc" id="L113">            actualInputStream.close()</span>
<span class="nc" id="L114">            bitmap</span>
<span class="nc" id="L115">        } catch (e: IOException) {</span>
<span class="nc" id="L116">            null</span>
        }
    }

    /**
     * Calculate the largest inSampleSize value that is a power of 2 and keeps both
     * height and width larger than the requested height and width.
     */
    private fun calculateInSampleSize(options: BitmapFactory.Options, reqWidth: Int, reqHeight: Int): Int {
<span class="nc" id="L125">        val height = options.outHeight</span>
<span class="nc" id="L126">        val width = options.outWidth</span>
<span class="nc" id="L127">        var inSampleSize = 1</span>

        // Use reasonable defaults if target dimensions are not available
<span class="nc bnc" id="L130" title="All 2 branches missed.">        val targetWidth = if (reqWidth &gt; 0) reqWidth else 1080</span>
<span class="nc bnc" id="L131" title="All 2 branches missed.">        val targetHeight = if (reqHeight &gt; 0) reqHeight else 1920</span>

<span class="nc bnc" id="L133" title="All 4 branches missed.">        if (height &gt; targetHeight || width &gt; targetWidth) {</span>
<span class="nc" id="L134">            val halfHeight = height / 2</span>
<span class="nc" id="L135">            val halfWidth = width / 2</span>

            // Calculate the largest inSampleSize value that is a power of 2 and keeps both
            // height and width larger than the requested height and width.
<span class="nc bnc" id="L139" title="All 4 branches missed.">            while (halfHeight / inSampleSize &gt;= targetHeight &amp;&amp; halfWidth / inSampleSize &gt;= targetWidth) {</span>
<span class="nc" id="L140">                inSampleSize *= 2</span>
            }
        }

<span class="nc" id="L144">        return max(1, inSampleSize)</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>